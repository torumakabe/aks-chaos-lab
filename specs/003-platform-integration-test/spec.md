# Feature Specification: プラットフォーム統合テストパイプライン

**Feature Branch**: `003-platform-integration-test`  
**Created**: 2024-12-10  
**Status**: Draft  
**Input**: User description: "アプリのCIは ci.yml で実現できていますが、プラットフォームを含めた統合テストを実現するパイプラインを作ります"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 手動トリガーによる統合テスト実行 (Priority: P1)

開発者がGitHub Actionsの画面から手動で統合テストパイプラインをトリガーし、プラットフォームを含めたフルスタックの統合テストを実行できる。

**Why this priority**: 統合テストはコストと時間がかかるため、プルリクエストごとの自動実行ではなく、必要なタイミングで開発者が明示的に実行する。これによりコスト効率を最大化しながら、本番デプロイ前の品質検証を実現する。

**Independent Test**: GitHub Actionsの「Run workflow」ボタンから手動実行し、統合テストが正常に完了することで確認可能。

**Acceptance Scenarios**:

1. **Given** 開発者がGitHub Actionsの画面にアクセスした, **When** 統合テストワークフローの「Run workflow」をクリックする, **Then** パイプラインが開始される
2. **Given** パイプラインが手動でトリガーされた, **When** 実行パラメータ（ブランチ、テスト範囲など）を指定する, **Then** 指定されたパラメータに基づいてテストが実行される
3. **Given** 統合テストパイプラインが実行中, **When** Bicepテンプレートに問題がある, **Then** パイプラインが失敗し、エラー内容が報告される

---

### User Story 2 - 統合テスト環境の自動プロビジョニング (Priority: P2)

手動トリガーされたパイプラインが、一時的な統合テスト環境をAzure上に自動的にプロビジョニングし、アプリケーションとインフラの統合テストを実行できる。

**Why this priority**: 実際のAzure環境でアプリケーションとプラットフォームの統合を検証することで、本番環境に近い条件でのテストが可能になる。手動トリガー後に実行される。

**Independent Test**: 手動トリガーで環境がプロビジョニングされ、テスト完了後に自動削除されることで確認可能。

**Acceptance Scenarios**:

1. **Given** 統合テストパイプラインがトリガーされた, **When** プロビジョニングフェーズが開始される, **Then** 専用のリソースグループに一時的なAKS環境がデプロイされる
2. **Given** 一時環境がプロビジョニングされた, **When** アプリケーションがデプロイされる, **Then** アプリケーションが正常に起動し、ヘルスチェックが成功する
3. **Given** テストが完了した（成功・失敗に関わらず）, **When** クリーンアップフェーズが実行される, **Then** 一時的なリソースグループとすべてのリソースが削除される

---

### User Story 3 - エンドツーエンドの機能テスト (Priority: P2)

統合テスト環境にデプロイされたアプリケーションに対して、APIエンドポイントへのリクエストを実行し、期待通りのレスポンスが返されることを検証する。

**Why this priority**: アプリケーションがプラットフォーム（AKS、Redis、Application Insightsなど）と正しく連携することを確認するために必要。P2-1と並行して価値を提供する。

**Independent Test**: 統合テスト環境でAPIエンドポイントを呼び出し、期待されるレスポンスを確認することで検証可能。

**Acceptance Scenarios**:

1. **Given** アプリケーションが統合テスト環境にデプロイされている, **When** ヘルスチェックエンドポイント（/health）が呼び出される, **Then** HTTP 200と正常なレスポンスが返される
2. **Given** アプリケーションとRedisが正しく接続されている, **When** キャッシュを使用するエンドポイントが呼び出される, **Then** Redis経由でデータが取得・保存される
3. **Given** Application Insightsが有効な環境, **When** APIリクエストが実行される, **Then** テレメトリがApplication Insightsに送信される

---

### User Story 4 - テスト結果のレポートと通知 (Priority: P3)

統合テストの実行結果がGitHub ActionsのUI上で明確に表示され、失敗時には詳細なログが確認でき、チームに通知される。

**Why this priority**: テスト結果の可視化は重要だが、テスト実行そのものが確立されてから意味を持つ。

**Independent Test**: テスト失敗時にGitHub Actionsの結果ページで詳細なエラー情報が表示されることで確認可能。

**Acceptance Scenarios**:

1. **Given** 統合テストが完了した, **When** GitHub Actionsの結果ページを確認する, **Then** 各テストステップの成功・失敗状態が明確に表示される
2. **Given** 統合テストが失敗した, **When** 失敗したジョブのログを確認する, **Then** 失敗の原因を特定できる詳細なエラーメッセージが含まれる

---

### Edge Cases

- 統合テスト環境のプロビジョニング中にAzureクォータ制限に達した場合、パイプラインは明確なエラーメッセージで失敗する
- 統合テスト中にパイプラインがキャンセルされた場合、クリーンアップジョブが実行されてリソースリークを防ぐ
- Azureの一時的な障害でデプロイが失敗した場合、設定可能なリトライ機構が動作する
- 統合テスト環境のクリーンアップに失敗した場合、GitHub Actionsの失敗ステータスで通知され、手動対応を促す
- Ingress Controllerが自己署名SSL証明書を使用している場合、統合テストでは証明書検証を無効化する（verify=False）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: パイプラインは`bicep build`を実行してBicepテンプレートを検証しなければならない
- **FR-002**: パイプラインは統合テスト用の一時的なAzure環境を`azd provision`を使用してプロビジョニングできなければならない
- **FR-003**: パイプラインはプロビジョニングされた環境に対してアプリケーションを`azd deploy`を使用してデプロイできなければならない
- **FR-004**: パイプラインはデプロイされたアプリケーションに対して、`/health`エンドポイントおよびRedis連携エンドポイントのHTTPベースの統合テストを実行できなければならない
- **FR-005**: パイプラインはテスト完了後、一時的なリソースグループを削除してクリーンアップしなければならない
- **FR-006**: パイプラインはAzure認証にOIDC（OpenID Connect）フェデレーション資格情報を使用しなければならない（シークレットの保存を回避）
- **FR-007**: パイプラインは手動実行（workflow_dispatch）のみをトリガーとしなければならない（コストと時間の最適化のため、プルリクエストやプッシュでは自動実行しない）
- **FR-008**: パイプラインは実行対象のブランチを選択できなければならない
- **FR-009**: パイプラインはインフラ変更のみ、アプリ変更のみ、またはフルテストを選択できる入力パラメータをサポートすべきである
- **FR-010**: パイプラインはAKS SKUモード（BaseまたはAutomatic）を選択できる入力パラメータをサポートしなければならない（デフォルト: Base）
- **FR-011**: パイプライン全体のタイムアウトは60分、クリーンアップジョブのタイムアウトは15分としなければならない
- **FR-012**: パイプラインは同時実行を1に制限し、後続の実行はキューイングしなければならない（concurrency group使用）

### Key Entities

- **統合テスト環境**: テスト専用の一時的なAzureリソースグループとそのリソース群（AKS、Redis、ACR、Application Insightsなど）
- **GitHub Actionsワークフロー**: `.github/workflows/`に配置される統合テストパイプライン定義
- **AZD環境**: `azure.yaml`で定義されたデプロイ構成を使用する環境インスタンス

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 開発者は手動トリガーから15分以内にインフラ変更の検証結果を確認できる
- **SC-002**: 統合テスト環境のプロビジョニングからアプリケーションデプロイまでの所要時間が35分以内である
- **SC-003**: 統合テスト完了後、一時リソースが100%クリーンアップされ、コスト漏れが発生しない
- **SC-004**: 統合テストにより、本番環境デプロイ前にプラットフォーム連携の問題を発見できる
- **SC-005**: パイプライン失敗時、開発者は失敗原因を5分以内に特定できるログが提供される

## Assumptions

- Azure環境へのアクセスにはGitHub ActionsからのOIDC認証が使用可能
- 統合テスト用のAzureサブスクリプションにはAKS、Redis、ACRなどのリソースをプロビジョニングするための十分なクォータがある
- 統合テスト環境は本番環境とは別のリソースグループに作成される
- テスト環境の識別には一意のサフィックス（GitHub Actions Run IDなど）が使用される
- 既存の`azure.yaml`と`infra/`のBicepテンプレートが統合テスト環境のプロビジョニングに使用される
- 統合テスト用のMSIには `Contributor` ロールに加えて `Azure Kubernetes Service RBAC Cluster Admin` ロールが必要（AKSへのkubectl操作のため）

## Clarifications

### Session 2024-12-10

- Q: 統合テスト環境で使用するAKS SKUモードは？ → A: パラメータで選択可能（Base/Automatic、デフォルト: Base）
- Q: パイプラインのタイムアウト設定は？ → A: 全体: 60分、クリーンアップ: 15分
- Q: 並列実行の制御は？ → A: 同時実行1に制限、後続はキューイング（concurrency group使用）
- Q: 統合テストで検証するAPIエンドポイントは？ → A: `/health` + Redis連携エンドポイント
- Q: クリーンアップ失敗時の通知先は？ → A: GitHub Actionsの失敗ステータスのみ（標準機能を活用）
